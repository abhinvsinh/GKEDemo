name: Terraform Plan

on:
  pull_request:
    paths:
      - terraform/**

permissions:
  contents: read
  id-token: write

env:
  PROJECT_NUMBER: 531610217280
  CLUSTER_NAME: gke-demo
  CLUSTER_ZONE: us-central1-a
  TF_VAR_project_id: gkedemo-485903
  TF_VAR_region: us-central1

jobs:
  terraform-plan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- GCP Authentication ----------
      # NOTE: workload_identity_provider MUST be literal
      # Env vars cannot be used here
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider-v2"
          service_account: github-actions@{{ env.TF_VAR_project_id }}.iam.gserviceaccount.com

      # ---------- Terraform Setup ----------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # ---------- Terraform Init ----------
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      # ---------- Terraform Validate ----------
      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      # ---------- Terraform Plan ----------
      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan

